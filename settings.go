package main

import (
	"github.com/kelseyhightower/envconfig"
	"log"
	"runtime"
	"crypto/x509"
	"crypto/tls"
	"encoding/base64"
)

var (
	settings Settings
	credentials Credentials
)

var LogLevelMap = map[string]int{
	"DEBUG":    LevelDebug,
	"INFO":     LevelInfo,
	"NOTICE":   LevelNotice,
	"WARN":     LevelWarn,
	"ERROR":    LevelError,
}

type Credentials struct {
	clientKeyPair tls.Certificate
	caCertPool    *x509.CertPool
}

type Settings struct {
	BIND_HOST                     string
	BIND_PORT                     int
	GODNS_READ_TIMEOUT            int
	GODNS_WRITE_TIMEOUT           int
	GODNS_UDP_PACKET_SIZE         int
	RESOLV_CONF_FILE              string
	BACKEND_RESOLVER_RW_TIMEOUT   int
	BACKEND_RESOLVER_TICK         int
	LOG_STDOUT                    bool
	LOG_FILE                      string
	LOG_LEVEL                     string
	ORACULUM_CACHE_BACKEND        string
	ORACULUM_CACHE_EXPIRE         int
	ORACULUM_CACHE_MAXCOUNT       int
	LOCAL_RESOLVER                bool
	INSECURE_SKIP_VERIFY          bool
	CLIENT_CRT_BASE64             string
	CLIENT_KEY_BASE64             string
	CA_CRT_BASE64                 string
	CLIENT_ID                     int
	CLIENT_ID_HEADER              string
	BACKEND_RESOLVERS             []string
	BACKEND_RESOLVERS_EXCLUSIVELY bool
	ORACULUM_API_FIT_TIMEOUT      int64
	ORACULUM_SLEEP_WHEN_DISABLED  int64
	ORACULUM_API_TIMEOUT          int64
	SINKHOLE_ADDRESS              string
	SINKHOLE_TTL                  int
	ORACULUM_ACCESS_TOKEN_VALUE   string
	ORACULUM_ACCESS_TOKEN_KEY     string
	ORACULUM_DISABLED             bool
	ORACULUM_URL                  string
	ORACULUM_IP_ADDRESSES_ENABLED bool
	Version                       string
	NUM_OF_CPUS                   int
}

func (s Settings) LogLevel() int {
	l, ok := LogLevelMap[s.LOG_LEVEL]
	if !ok {
		panic("Config error: invalid log level: " + s.LOG_LEVEL)
	}
	return l
}
/*
var (
	clientCertPEMBase64 string = "Q2VydGlmaWNhdGU6CiAgICBEYXRhOgogICAgICAgIFZlcnNpb246IDMgKDB4MikKICAgICAgICBTZXJpYWwgTnVtYmVyOiAxICgweDEpCiAgICBTaWduYXR1cmUgQWxnb3JpdGhtOiBzaGExV2l0aFJTQUVuY3J5cHRpb24KICAgICAgICBJc3N1ZXI6IEM9Q1osIFNUPUN6ZWNoIHJlcHVibGljLCBMPUJybm8sIE89U2lua2l0LCBDTj1vcmFjdWx1bS9lbWFpbEFkZHJlc3M9a2FybUBlbWFpbC5jegogICAgICAgIFZhbGlkaXR5CiAgICAgICAgICAgIE5vdCBCZWZvcmU6IE5vdiAyNyAyMjo1NTozNiAyMDE2IEdNVAogICAgICAgICAgICBOb3QgQWZ0ZXIgOiBOb3YgMjcgMjI6NTU6MzYgMjAxNyBHTVQKICAgICAgICBTdWJqZWN0OiBDPUNaLCBTVD1DemVjaCByZXB1YmxpYywgTD1Ccm5vLCBPPVNpbmtpdCwgQ049cmVzb2x2ZXIvZW1haWxBZGRyZXNzPWthcm1AZW1haWwuY3oKICAgICAgICBTdWJqZWN0IFB1YmxpYyBLZXkgSW5mbzoKICAgICAgICAgICAgUHVibGljIEtleSBBbGdvcml0aG06IHJzYUVuY3J5cHRpb24KICAgICAgICAgICAgICAgIFB1YmxpYy1LZXk6ICg0MDk2IGJpdCkKICAgICAgICAgICAgICAgIE1vZHVsdXM6CiAgICAgICAgICAgICAgICAgICAgMDA6OWI6NWE6MDE6NGI6NzQ6NDg6ODU6ZmI6YmU6Yzg6NDI6YTE6Yjk6ZjQ6CiAgICAgICAgICAgICAgICAgICAgNjI6MmQ6Zjk6OGQ6MTg6MWI6MWQ6OTI6ZTk6YTQ6YWM6ODI6ZjM6MmM6MDc6CiAgICAgICAgICAgICAgICAgICAgZWI6ZmM6Mjc6NjQ6OGM6NDY6Zjc6ZWE6ZGI6MzQ6Njc6OWI6NWI6ZWU6NmQ6CiAgICAgICAgICAgICAgICAgICAgZTA6ZDA6OTA6ODE6NTI6OTU6NWI6ODQ6YWI6NjY6ODE6YjI6MWI6Yzc6ZDc6CiAgICAgICAgICAgICAgICAgICAgYmE6M2M6YzM6NzU6ZGY6N2I6YTI6NTI6MGE6NjE6MzY6YTI6YmM6OTE6OGQ6CiAgICAgICAgICAgICAgICAgICAgMDU6Nzc6MjE6ZGY6MzU6MzE6MmY6ZmY6MGM6MWM6NTI6YzM6OGY6ZDk6ZWQ6CiAgICAgICAgICAgICAgICAgICAgZTc6OTY6NDE6NmY6Y2Q6MTI6MWU6NGM6Yzk6NTM6OTM6MDU6OTQ6Y2Q6ZWE6CiAgICAgICAgICAgICAgICAgICAgMDA6M2Y6ODM6MmY6MjY6NDA6Y2Q6NWM6MWU6YzU6NTU6OTM6OTA6NjQ6MDE6CiAgICAgICAgICAgICAgICAgICAgOGE6ZDg6OWI6ZWE6MWU6NjI6MGM6MTQ6Yjc6MzA6YzU6NGU6NjI6Mzc6ZDc6CiAgICAgICAgICAgICAgICAgICAgMjA6YjE6OWI6YWU6NGI6NzA6ZTg6ZmQ6MzE6MWM6NDU6M2E6YTg6ZTY6YTQ6CiAgICAgICAgICAgICAgICAgICAgN2I6YjA6MTE6ODk6YWM6ODQ6MzU6ZTk6NGI6Y2M6NDY6M2Q6ZWI6Zjc6NzM6CiAgICAgICAgICAgICAgICAgICAgZDI6MDA6ZWI6ZmU6MmQ6MmI6NTc6ZDA6N2Q6MTQ6MGI6ODk6NTM6MTM6OTM6CiAgICAgICAgICAgICAgICAgICAgYzQ6ZGE6Yzc6NDE6NzM6Yjk6YWE6Nzc6YzM6ODk6Yjk6MzQ6YzY6MjU6ZDY6CiAgICAgICAgICAgICAgICAgICAgODI6MzI6MmU6YTc6ZmE6ZWQ6ZDI6MWE6ZTI6NWY6MmM6MjM6NTM6ZmU6N2I6CiAgICAgICAgICAgICAgICAgICAgN2I6NTQ6NGU6NDk6Yjc6ZmI6ZmE6YjE6MzI6NjQ6YzQ6NWY6MGQ6N2E6M2Y6CiAgICAgICAgICAgICAgICAgICAgMDQ6ZTM6MmY6OTk6ODM6OTQ6NTg6Yzk6MzU6NTQ6MDc6ZDg6Y2Y6Y2M6Mzg6CiAgICAgICAgICAgICAgICAgICAgZmE6Zjk6MzU6ZjQ6MWE6ZGU6OTM6YmQ6YjA6ODc6Y2I6NGQ6MmY6NzQ6MzU6CiAgICAgICAgICAgICAgICAgICAgMjg6NjQ6ZTU6M2M6YjQ6YjU6NmU6ZTY6ZjA6YmU6Yzg6Mzk6NGQ6YjQ6MWE6CiAgICAgICAgICAgICAgICAgICAgNmY6MTE6YTU6MWM6N2I6Mzg6NTU6MDY6NDY6OWM6YWI6MjA6NzM6MzQ6NTI6CiAgICAgICAgICAgICAgICAgICAgODk6YzM6MDY6ZjA6Y2U6ZTg6ZTE6MjA6OGM6ZWU6Nzc6ZDk6MGQ6MWM6NmU6CiAgICAgICAgICAgICAgICAgICAgODI6Yzk6Mzg6ZTU6Y2Q6NDM6MzQ6Mzg6ZTE6ODg6OWE6NWE6MTM6OTU6MmY6CiAgICAgICAgICAgICAgICAgICAgMGI6ZjE6MDM6ZTk6ZjY6MDU6OTU6Njk6ZmQ6YjU6ZTg6MDc6ZWE6YTM6ZDc6CiAgICAgICAgICAgICAgICAgICAgYzI6ZDE6ZDQ6OGM6ZjA6OGU6ZWY6NDg6MWE6YjU6ODM6NTg6NTM6Mzg6M2M6CiAgICAgICAgICAgICAgICAgICAgMTQ6YjE6M2Q6ZWY6YWQ6OTk6Mjc6OWY6ZWY6MmI6YjI6YTU6ZTg6MWU6NjI6CiAgICAgICAgICAgICAgICAgICAgMjI6NTM6Zjg6Njg6OTU6ODU6MzE6MmQ6N2M6YmM6ZWU6OGU6YTA6MjU6NmE6CiAgICAgICAgICAgICAgICAgICAgMTk6ZjM6M2M6MGY6YzA6OWU6NTc6NWQ6ZTg6NGI6NWU6YzM6YTI6MjY6ODY6CiAgICAgICAgICAgICAgICAgICAgNDg6YzM6OTQ6NmM6YmM6NzM6ZjY6ZjU6YjU6ZGM6MzI6ZWU6OTI6Y2Y6YjU6CiAgICAgICAgICAgICAgICAgICAgMTM6YjA6N2U6YmQ6NjQ6YTg6MDY6NjA6NmY6MGY6ZjI6YWY6MTg6MDQ6ZjY6CiAgICAgICAgICAgICAgICAgICAgNzg6NDk6ZTA6YjY6ZDg6ZTQ6NzI6OTU6NmE6OTA6NzM6NTY6MmM6OTE6ODA6CiAgICAgICAgICAgICAgICAgICAgN2E6ZDk6N2I6YTY6ZDE6NGI6YmY6MTc6NTk6MmE6MGE6ZWY6ZGU6NzM6ZjI6CiAgICAgICAgICAgICAgICAgICAgMGI6M2U6YWY6MzE6YTA6YzI6OGM6M2E6YWM6NjU6Yzg6MTA6YmQ6YTA6ZjE6CiAgICAgICAgICAgICAgICAgICAgMDI6YjU6NmQ6MzY6YmM6ZDE6ZmE6MWE6ZGU6MzA6MWQ6NDY6M2Q6NWQ6MmU6CiAgICAgICAgICAgICAgICAgICAgMDk6ZTU6MWQ6NjY6MWY6Nzc6ZWU6NjQ6ODU6NGE6Nzc6ODY6OTA6Mjc6MzM6CiAgICAgICAgICAgICAgICAgICAgM2E6NWY6OTA6OTQ6OTk6MmY6Mzg6ODI6NTU6ZWQ6ZDk6ZTU6NTY6OTM6M2M6CiAgICAgICAgICAgICAgICAgICAgZGQ6NTU6MmYKICAgICAgICAgICAgICAgIEV4cG9uZW50OiA2NTUzNyAoMHgxMDAwMSkKICAgICAgICBYNTA5djMgZXh0ZW5zaW9uczoKICAgICAgICAgICAgWDUwOXYzIEJhc2ljIENvbnN0cmFpbnRzOiAKICAgICAgICAgICAgICAgIENBOkZBTFNFCiAgICAgICAgICAgIE5ldHNjYXBlIENvbW1lbnQ6IAogICAgICAgICAgICAgICAgT3BlblNTTCBHZW5lcmF0ZWQgQ2VydGlmaWNhdGUKICAgICAgICAgICAgWDUwOXYzIFN1YmplY3QgS2V5IElkZW50aWZpZXI6IAogICAgICAgICAgICAgICAgOTk6NzY6Nzc6QTI6NDI6NUM6QTA6MjU6NTY6QTE6ODg6MDQ6REU6MEU6NDA6MDk6MTQ6MEI6NUY6NkYKICAgICAgICAgICAgWDUwOXYzIEF1dGhvcml0eSBLZXkgSWRlbnRpZmllcjogCiAgICAgICAgICAgICAgICBrZXlpZDo1MjoyMDo1MjowNjpEQjo2RjpERjo3MzoyQjpDODo0OTpCMTpGQjpBQTpCOTo2NDpGRDo3ODpGODo1RQoKICAgIFNpZ25hdHVyZSBBbGdvcml0aG06IHNoYTFXaXRoUlNBRW5jcnlwdGlvbgogICAgICAgICA3MzozNDphZDo4MDoxNDphMTphZjo2NToxMTo4Yzo5ZDoyZDplYTo0Yzo3ODowODo0MzpkMjoKICAgICAgICAgNDE6MTE6YWY6NDc6NjY6YjA6ZDc6ODI6ZmI6NzM6OWM6ZTA6MjM6NmY6NjM6N2Q6MDc6Yjc6CiAgICAgICAgIDMyOjg4OjA0OjNhOjg4OmVkOmM3OjljOjk2Ojg3OjBiOjAwOjYzOjE3Ojk3OmEwOmRkOjllOgogICAgICAgICA2YzplMzphNzo0Mjo2ZDpmOTowODo4NTplMzo1Zjo2Zjo0NDpiZDoyNTo1NDo2ZjphMDo3ZDoKICAgICAgICAgZmI6YjI6ZWU6MDI6ZjY6ZWQ6ZDk6OTY6MmE6MzE6N2E6OTg6MWM6NDc6MTg6MjI6YTI6ZjA6CiAgICAgICAgIDA4OjA1OjcyOmZkOjhhOmVhOmEzOmFhOmE5OmM1Ojg3OjZhOmZkOjkwOmM3Ojc1Ojc4OjRiOgogICAgICAgICA4NTplODowNDo0ZTo0ODpkZjoyOTphZTozMjphNzo5NDpmMDo4ZTo1NjpmMDozYTowMTo0YjoKICAgICAgICAgYjE6OGE6ZDM6NTA6OWY6OWE6ZjM6MjM6YjA6YjU6NjM6ZjY6NjY6N2Q6MDg6YTA6OTM6NTI6CiAgICAgICAgIDdkOmNjOjUwOjkzOjU0OjE1OmZkOjE1OjUwOmYzOjIyOjU4OmRlOmZmOjhiOmZhOjc1OjIxOgogICAgICAgICBkODo4ZjoxYzplNjo0Njo5ODoxMTo3Njo1NjpkZTpiNToxZjo1MzphMjplMTowMDowZjoxYjoKICAgICAgICAgNTc6ZWI6Mjg6M2Y6NjU6YTk6MWI6M2M6ZWE6NmY6YWM6MmE6NDM6MmQ6NTY6M2Q6MGY6MTI6CiAgICAgICAgIDliOjQzOjQ4OmVkOmUxOjI5OjA1OjcyOjUxOjQzOmZlOjI3OjQ3OjdjOjMxOmUwOjg4OmE1OgogICAgICAgICAyZDoyMDo3YjoyZjo4MDo3ZDo4YTpjMzpjYzoyNTo2ZTphMzpmMzpiMzphMzpiZToxNDo1ZjoKICAgICAgICAgY2Q6YjM6MTg6Njc6NDg6OWI6ZDM6MjU6MmM6NzI6NDk6ODc6YWM6Mjg6ZTY6NTM6NTQ6YmU6CiAgICAgICAgIDlhOjNmOmI2OjFhOmE3OjQ4OjYxOjZmOjg2OmY0OjhmOjE3OmM5OmUzOjA5OjhhOjc0OjAwOgogICAgICAgICBmMzo4NzpmYjozNjo3MDo5Mjo1NTo5Mjo2MDo0MDo4ZDpjNTozYzo0MzpiMzphNDowZDpjNDoKICAgICAgICAgNjY6ODA6MTU6YmI6NWU6ODk6ZmM6Yjg6MmE6ODg6ZjI6ZGQ6NTM6ZTg6MWU6NDQ6MWM6Zjc6CiAgICAgICAgIGRhOjIyOjc2OjVhOmFlOjM4OjA0OjVkOjY4OjFmOjg0OjdkOmM1OmIyOjk2OjE5OjkwOjg1OgogICAgICAgICBhNzo1MjpkYjozNjpjZDplNDozNDo1Yjo3NzphYzo4Yjo0ZDplMzowNjo5ZTo2MToxNzphMToKICAgICAgICAgMzM6YjY6NGE6ZTU6NmM6YTg6ZGU6YjE6YzU6MDM6YTA6OGY6Nzc6YmQ6NDI6MTQ6ODQ6OTg6CiAgICAgICAgIGRiOmQyOjlmOmNhOmNmOmQ4OmExOjMxOmVhOjE2OjY5OjBlOmM4OmRmOjllOjBmOjIxOjcyOgogICAgICAgICAzMzo0ZDo0MDo2OTpjMToxYzo4ODoyNzoyMDphMjo0ODo4OTo4Nzo1ZTpiYjpkMDphMjo2ZjoKICAgICAgICAgMjE6OTk6MTQ6Mzk6NWE6Yjc6Mjg6NGI6NTQ6MDk6ZGM6YWQ6Zjk6YjM6MDI6ZDc6YWE6Y2M6CiAgICAgICAgIDQ2OjQ1OjY3OmU4OmRmOjEwOjFmOjgwOjBiOjI0OjJmOjU0OmZhOmFkOjM4OjRkOmY3OjEyOgogICAgICAgICBmNjo3Mjo3OToxZDoyYjpmMDplNzo5NToxNDozYjphYToyMzowYTpkMDowYjpmZjo1MjpjYToKICAgICAgICAgMjQ6ZjE6MWQ6Zjk6YzY6YWI6YjA6YzE6NGM6Njg6MTM6ZDM6OWU6N2I6OGI6ZmE6N2E6NTM6CiAgICAgICAgIDMwOmU1OmIzOjA1OjMzOjkwOjg5OjE4OjM0OmU0OjAxOmU5OmUzOmUyOjcyOjYwOjUxOmI5OgogICAgICAgICBlZjo5NDoyOToyMTo3MTozODo5Yzo4MDphOTo0Yjo1Nzo2MjowMToxNzpmYjpkYzphZTo2ZToKICAgICAgICAgNzc6MTI6NDc6YWM6ZGY6ZTA6NTg6NDkKLS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUY1RENDQTh5Z0F3SUJBZ0lCQVRBTkJna3Foa2lHOXcwQkFRVUZBREIzTVFzd0NRWURWUVFHRXdKRFdqRVgKTUJVR0ExVUVDQXdPUTNwbFkyZ2djbVZ3ZFdKc2FXTXhEVEFMQmdOVkJBY01CRUp5Ym04eER6QU5CZ05WQkFvTQpCbE5wYm10cGRERVJNQThHQTFVRUF3d0liM0poWTNWc2RXMHhIREFhQmdrcWhraUc5dzBCQ1FFV0RXdGhjbTFBClpXMWhhV3d1WTNvd0hoY05NVFl4TVRJM01qSTFOVE0yV2hjTk1UY3hNVEkzTWpJMU5UTTJXakIzTVFzd0NRWUQKVlFRR0V3SkRXakVYTUJVR0ExVUVDQXdPUTNwbFkyZ2djbVZ3ZFdKc2FXTXhEVEFMQmdOVkJBY01CRUp5Ym04eApEekFOQmdOVkJBb01CbE5wYm10cGRERVJNQThHQTFVRUF3d0ljbVZ6YjJ4MlpYSXhIREFhQmdrcWhraUc5dzBCCkNRRVdEV3RoY20xQVpXMWhhV3d1WTNvd2dnSWlNQTBHQ1NxR1NJYjNEUUVCQVFVQUE0SUNEd0F3Z2dJS0FvSUMKQVFDYldnRkxkRWlGKzc3SVFxRzU5R0l0K1kwWUd4MlM2YVNzZ3ZNc0IrdjhKMlNNUnZmcTJ6Um5tMXZ1YmVEUQprSUZTbFZ1RXEyYUJzaHZIMTdvOHczWGZlNkpTQ21FMm9yeVJqUVYzSWQ4MU1TLy9EQnhTdzQvWjdlZVdRVy9OCkVoNU15Vk9UQlpUTjZnQS9neThtUU0xY0hzVlZrNUJrQVlyWW0rb2VZZ3dVdHpERlRtSTMxeUN4bTY1TGNPajkKTVJ4Rk9xam1wSHV3RVltc2hEWHBTOHhHUGV2M2M5SUE2LzR0SzFmUWZSUUxpVk1UazhUYXgwRnp1YXAzdzRtNQpOTVlsMW9JeUxxZjY3ZElhNGw4c0kxUCtlM3RVVGttMysvcXhNbVRFWHcxNlB3VGpMNW1EbEZqSk5WUUgyTS9NCk9QcjVOZlFhM3BPOXNJZkxUUzkwTlNoazVUeTB0VzdtOEw3SU9VMjBHbThScFJ4N09GVUdScHlySUhNMFVvbkQKQnZETzZPRWdqTzUzMlEwY2JvTEpPT1hOUXpRNDRZaWFXaE9WTHd2eEErbjJCWlZwL2JYb0IrcWoxOExSMUl6dwpqdTlJR3JXRFdGTTRQQlN4UGUrdG1TZWY3eXV5cGVnZVlpSlQrR2lWaFRFdGZMenVqcUFsYWhuelBBL0FubGRkCjZFdGV3NkltaGtqRGxHeThjL2IxdGR3eTdwTFB0Uk93ZnIxa3FBWmdidy95cnhnRTluaEo0TGJZNUhLVmFwQnoKVml5UmdIclplNmJSUzc4WFdTb0s3OTV6OGdzK3J6R2d3b3c2ckdYSUVMMmc4UUsxYlRhODBmb2EzakFkUmoxZApMZ25sSFdZZmQrNWtoVXAzaHBBbk16cGZrSlNaTHppQ1ZlM1o1VmFUUE4xVkx3SURBUUFCbzNzd2VUQUpCZ05WCkhSTUVBakFBTUN3R0NXQ0dTQUdHK0VJQkRRUWZGaDFQY0dWdVUxTk1JRWRsYm1WeVlYUmxaQ0JEWlhKMGFXWnAKWTJGMFpUQWRCZ05WSFE0RUZnUVVtWFozb2tKY29DVldvWWdFM2c1QUNSUUxYMjh3SHdZRFZSMGpCQmd3Rm9BVQpVaUJTQnR0djMzTXJ5RW14KzZxNVpQMTQrRjR3RFFZSktvWklodmNOQVFFRkJRQURnZ0lCQUhNMHJZQVVvYTlsCkVZeWRMZXBNZUFoRDBrRVJyMGRtc05lQyszT2M0Q052WTMwSHR6S0lCRHFJN2NlY2xvY0xBR01YbDZEZG5temoKcDBKdCtRaUY0MTl2UkwwbFZHK2dmZnV5N2dMMjdkbVdLakY2bUJ4SEdDS2k4QWdGY3YySzZxT3FxY1dIYXYyUQp4M1Y0UzRYb0JFNUkzeW11TXFlVThJNVc4RG9CUzdHSzAxQ2Ztdk1qc0xWajltWjlDS0NUVW4zTVVKTlVGZjBWClVQTWlXTjcvaS9wMUlkaVBIT1pHbUJGMlZ0NjFIMU9pNFFBUEcxZnJLRDlscVJzODZtK3NLa010VmowUEVwdEQKU08zaEtRVnlVVVArSjBkOE1lQ0lwUzBnZXkrQWZZckR6Q1Z1by9Pem83NFVYODJ6R0dkSW05TWxMSEpKaDZ3bwo1bE5VdnBvL3RocW5TR0Z2aHZTUEY4bmpDWXAwQVBPSCt6WndrbFdTWUVDTnhUeERzNlFOeEdhQUZidGVpZnk0CktvankzVlBvSGtRYzk5b2lkbHF1T0FSZGFCK0VmY1d5bGhtUWhhZFMyemJONURSYmQ2eUxUZU1Hbm1FWG9UTzIKU3VWc3FONnh4UU9najNlOVFoU0VtTnZTbjhyUDJLRXg2aFpwRHNqZm5nOGhjak5OUUduQkhJZ25JS0pJaVlkZQp1OUNpYnlHWkZEbGF0eWhMVkFuY3JmbXpBdGVxekVaRloramZFQitBQ3lRdlZQcXRPRTMzRXZaeWVSMHI4T2VWCkZEdXFJd3JRQy85U3lpVHhIZm5HcTdEQlRHZ1QwNTU3aS9wNlV6RGxzd1V6a0lrWU5PUUI2ZVBpY21CUnVlK1UKS1NGeE9KeUFxVXRYWWdFWCs5eXVibmNTUjZ6ZjRGaEoKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo="
	clientKeyPEMBase64 string = "LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUpRd0lCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQ1Mwd2dna3BBZ0VBQW9JQ0FRQ2JXZ0ZMZEVpRis3N0kKUXFHNTlHSXQrWTBZR3gyUzZhU3Nndk1zQit2OEoyU01SdmZxMnpSbm0xdnViZURRa0lGU2xWdUVxMmFCc2h2SAoxN284dzNYZmU2SlNDbUUyb3J5UmpRVjNJZDgxTVMvL0RCeFN3NC9aN2VlV1FXL05FaDVNeVZPVEJaVE42Z0EvCmd5OG1RTTFjSHNWVms1QmtBWXJZbStvZVlnd1V0ekRGVG1JMzF5Q3htNjVMY09qOU1SeEZPcWptcEh1d0VZbXMKaERYcFM4eEdQZXYzYzlJQTYvNHRLMWZRZlJRTGlWTVRrOFRheDBGenVhcDN3NG01Tk1ZbDFvSXlMcWY2N2RJYQo0bDhzSTFQK2UzdFVUa20zKy9xeE1tVEVYdzE2UHdUakw1bURsRmpKTlZRSDJNL01PUHI1TmZRYTNwTzlzSWZMClRTOTBOU2hrNVR5MHRXN204TDdJT1UyMEdtOFJwUng3T0ZVR1JweXJJSE0wVW9uREJ2RE82T0Vnak81MzJRMGMKYm9MSk9PWE5RelE0NFlpYVdoT1ZMd3Z4QStuMkJaVnAvYlhvQitxajE4TFIxSXp3anU5SUdyV0RXRk00UEJTeApQZSt0bVNlZjd5dXlwZWdlWWlKVCtHaVZoVEV0Zkx6dWpxQWxhaG56UEEvQW5sZGQ2RXRldzZJbWhrakRsR3k4CmMvYjF0ZHd5N3BMUHRST3dmcjFrcUFaZ2J3L3lyeGdFOW5oSjRMYlk1SEtWYXBCelZpeVJnSHJaZTZiUlM3OFgKV1NvSzc5NXo4Z3MrcnpHZ3dvdzZyR1hJRUwyZzhRSzFiVGE4MGZvYTNqQWRSajFkTGdubEhXWWZkKzVraFVwMwpocEFuTXpwZmtKU1pMemlDVmUzWjVWYVRQTjFWTHdJREFRQUJBb0lDQUJjK21sNzk0VFFhL09yZC9YRGpmaVUrCjU3dXBvdjB1ZEhOVGpLc1Q3RjFvVDRVbHdVYWswZXlHdEhTeWdDYjAyRVRSRUVhRGx1emxCMzhaYWtaWlFMUFYKdmUza203TWZHblAwMDlLRmdPNW1rN1hueS8wZVFkSHI1UEQ0alkvem5CRUZOcm9TNWJjQndsTytmem1NREs0eAo5SGpmZ1lWVkxiOUhaUHB5MVRmc1NTSGNucG1ZV00zNmExUGlheG9uVlFHT3kyTG5UWktFclVMZzdXZ2c3VW05ClRpZFNieU93Sy9INlFFTnowNkgrUkMzenVFcTc4YkV0SUxLVzBXNmkxTnNvZzRhYXNJdTlOZWpMNGsycVk1RDYKVFBQS1d3RnFkSkk2NWhUejNBSmtsNGlld0t1TmNOTjZaVDVmVkloTUpsRlBuMXk5M1FGTy9xS094QUR4U3ovQgoxMHJFVUowdk5IeTJIUGs2NTN5cDZ6L3ZMb2psS0JMTFlnQ0dOc3cxTXJjWXZlRDE4YTZjUWNTVXI4YzFlVXI1ClYzdm5Lb3NSMTc2RWNLT0ZQdThYc1FLSFJnTFdKNkhQWFlsS3VEZFdpeEU3TzBzQ2E1ZVZhUXhBUEV1UGE1V3kKVEdnRUgwTDllWkJXcnB0VFgxaHcxVnE3NE1TemhrZ2s5SHp3WEdybTR2UW9BSmptVWZsRmVGS1ZqVkZlK1pDYwpqY2o4Q0NVVnl4akY0LzRxcThVY1djaVFOemZmWHRldSs0RHl6TFRjU3NZTFJSWnR0UlpHVUxyNFh4cTA5RGRuCklHOTVMT29CRHozTDZ1bGNoay8wVHVsVE85UnVjbGdxVE9HNXNDQjl6bFZkWDg4bnh1UVVCSDRCaXFwaHhyaEsKQjNjaXVZdDZDRW4wbkwwaFU5Q2hBb0lCQVFESDZUSXJpcHd5c2g0MGVCZXVoZGJwT09JZGVaQUgwM0ZQWGdwYwpZVlpvVXppc3U4KzRjY2hNdTlKdmZQTkhZanBSSk1zUmN1LzBoQWxneXQ0THoyRHpJL2FXQ0hRNFlyWUdlR1ovCm91Q1MyUGRaWnlQWG1uNE5QYmFSTS9ua0NmdzN4Q0pTaXdFUUJ4Z1hqTzhDdHIxTXJTRTRsY3RGNHhyd2QrZlgKMENqL3gyV2s2SzFSR2ZyQW5ITTEyaVVhcVRaTHFnY3g3eDNhd0c5WFVoaUo1WTVLUkxzWm9YTThscGJCbUxPZAprek5uTGx6L2JIL2o0T2lPMkpiVTloeGFWSEZxb1NPZSttUXR1UnI0eTFmVHVCRXlJQkkzblQyd0V1bGhvcDNkCllsaGcrd3FTSG1MUFNheTA1eGF5QXNMKzJzZXZxcS80c0hkZ1BhWGZQOEFKSFJPM0FvSUJBUURHOEVvYlVpazUKOVphVWV2eU1lU081T252MWRlZmVZQ3k1dVFLeEdSQUwwaWhYUldIYkowMlpKdXdvWGJaNmdmR1hUVitLcnBkVQpOR3pXcnJqbnBSZ3BraUZlL3dHUWYydFB0eHdEZVpnaTN1eGs0Q1V3UHVvV21MS3hHdGJhcmQvcnhYeVRTb3pHCnJ2TDdrUHhaS1FzTDc0dTVkNE9rb2VQYXNUbWJ1dmdMMExMcnZya3laSVd5TXZlVnVubE1jQWpaNFJGYXBmckIKT1AwRVdWTU5LWS85RGc1eHdaWGh0L1lydjU3b2RsY2thcGNpR25pamlKeVRKL0dIVld5dFJab0VEUXZ1aHorTwo1R0pMaGtBM21aLzN1UHN2TXhCRzlEc0dVTGlldmo2bm1ZMkpvWWVFVFZFK2ZZbExYeFNlMitrYU1wejZKODhpCmZqeGF0VXhJUHZwSkFvSUJBRXRNUmM1cXRpek9ORnhWQTY2RDBSQWxrZDNDUlFMOW5JZGxoNGVHVGxLYlRoU1oKNVVLMjhOZ2VRc1FsajBqSzhlWlFjb0NQQjF6VlF1Y0hZcDJXTGhGRzhZRlBpOThWSnpUR3N1ek9mOEl3SVBLMgp5NlJSRjd1TERESWpIclBMSXdvcVFUZFFEa1ZvTnFYZ09zS043RDF1Vkw0SWhmazc4cEN5eVV2YnB5VzRpRXVXCkxIb0l6QTh5bnA2aEhTcXVvN25hUUQySnNIZ04xYUpSVk5iVDlVVjZIL01tZ2M1SGRsOVRVZ3cvUHJSVm5VZkUKS1dPKytqbWIwU3hEeXlnbStGVk9mcWxKN09QZi9nM0tJYm1vY2ltc05OQm4xSzEyWWh1WmNkYktUVG15TlNnVwpjK2RaKzhoajVvT0VVTWhIeGNFZ0RJb2loY1JsVkE0RDZDUkdwSDhDZ2dFQkFJMnBWbHdXS1oxSU1LNFMxZndCCjExcHpOd29YcDhGR294S3RtQ2tjTzd6dkxpTFhHVlBCclJRK0R6Uy9aczNkOG5kWGRZMS92ZXNNV2VTV0RyMkYKWnF0VGo4Zmh0dTk2aktQN05FdVZMcXpHS1hlNzFUK0J6WmZCckoxSkMyNDFHcHI5eWpQb2hrNkZEaW50bUlTMQpJVlNpZzlEU05qL3B1Q05teUNzSS9ORU5FQnVuZUtGVnk0NlZsSkJlZFRubEhhaHBDTDZRS3Z1azVTZFBwRUJmCk5GVnl5UDVnWjZhUUpSQUtKOUpKVXN4dnlxZFNTazNKWGhXNy85WHJFclJnTjhoaXNmaHMvdWwxNERqL3BJTHoKTm1Ka3F4bDFOMFlQYkdpVzJxRFB3RFlBdGpVbmZTVE5HZWx4NDI1MGltNkZFbnpCUmQ4c3NlZFNGUkJTd2J0QQpmV0VDZ2dFQkFLUkwrSERGNldiY2wvT0RxYmxqOHJmNnh3clRyZU5XUndsNjZHUE40SGZSSDR3MUZyWjJRbVRHCitRZ2UvOGFVRTZpSklhOFV5WDRiZytJQWdrZVhJT2VZN2JveUUyOCs4K2QyTkFMT1puc0xDZjZScHEzdXk2cjIKeHFkc0tGSnB3Q1J0QVRuc3dwU0EvOHU2TDBPd3o3L25GZnRDZ00vV0VtUVZ1RmxYSWZXd1c5KzNMWGpVSUhFRQovUnlpM1ZoMmtGMlQwaEF2SDNZbUtjd0NSZW44VUhubWRPRlRKOUd0ZmQ1VnJKQ01IUFpER3pza0c0b0NBT2tnCjNZVUxQUk5RcEpMYnJQWFRQNGUzK3ZnVitwcDNIZ3N6clgrVVJQRlk0WXVBOVRhelZSWEFSNkhJazVBaGgyYUUKL3dmM3FST3BOd1MxbnpKLzM1R1p4NDJvLy9NQzNCRT0KLS0tLS1FTkQgUFJJVkFURSBLRVktLS0tLQo="
	caCertPEMBase64 string = "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUZ3VENDQTZtZ0F3SUJBZ0lKQUl5R1UzS3RnOFBvTUEwR0NTcUdTSWIzRFFFQkN3VUFNSGN4Q3pBSkJnTlYKQkFZVEFrTmFNUmN3RlFZRFZRUUlEQTVEZW1WamFDQnlaWEIxWW14cFl6RU5NQXNHQTFVRUJ3d0VRbkp1YnpFUApNQTBHQTFVRUNnd0dVMmx1YTJsME1SRXdEd1lEVlFRRERBaHZjbUZqZFd4MWJURWNNQm9HQ1NxR1NJYjNEUUVKCkFSWU5hMkZ5YlVCbGJXRnBiQzVqZWpBZUZ3MHhOakV4TWpjeU1qUTBNekJhRncweU1URXhNREV5TWpRME16QmEKTUhjeEN6QUpCZ05WQkFZVEFrTmFNUmN3RlFZRFZRUUlEQTVEZW1WamFDQnlaWEIxWW14cFl6RU5NQXNHQTFVRQpCd3dFUW5KdWJ6RVBNQTBHQTFVRUNnd0dVMmx1YTJsME1SRXdEd1lEVlFRRERBaHZjbUZqZFd4MWJURWNNQm9HCkNTcUdTSWIzRFFFSkFSWU5hMkZ5YlVCbGJXRnBiQzVqZWpDQ0FpSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnSVAKQURDQ0Fnb0NnZ0lCQU9TWG9mS0thU0lkZWUvNUVQbmwzbWcyTXJ5bWJTaWFNNkRhMlhSZm55RXJEcWF2emdsWQpuRmhLS0dZUkVPVFh0cWIzeTlpRG5xTEhsaXB2MWpKb085cjFsVFlDOXpLUUo5WjdoOS9CYW5KdjJTNkxaT2lBCk9Hc0Vzb3l6bHY3WmhuM2lkclI3REVzVVZGUW1GUkc0TzlVNlVLYmFVY0p2S0RUbTFJd253eWxxMWtGc3JkYisKRXVJRlNvcnB1Rjhwdjd1aVhFK1VyOVV0eEtBZWVCa0JkdnIwWFZlVUhjQTRBOWNGTWxxd25QSUtZRlE3SDVReApIRCs1Vy9ETU5wVnBzd2Vyb203OUNNUCtmakMyQVFYRTlGaHZ2TVd2QlFiWlQrVW1pTkwyQk1ZZFl2MUJ1RzhlCmlPZnlRRlBxVzRsUGs2cEJlRTFKTE44Vm5WaG5UdXlvbWZNRHIwcmd2N3grV3g0ajMzRkFMcFlaWEtpamVUalkKNXVudGZNK0NZL3VjNzZiN1hqYlFvZHRmRldSdEw2cGZsTndZZVNLQVFOWGtKMm1NQUZ3dHJPQjZkMVEwaWdqbAp6eXdqU1hneWhSdmhaZVpQMGhITko2OERWd2R0eVNIaVY3cVpnMjMxcldEWnBMS0NmSldDQUp4bTZXbktPTjlxCitqWjdKN1lxTkJ4aWtrN1BxWGdqMFc0eE80SlNCVFc1d3VDWm9yd2pwVFZJaDVzdm14VnVld1JWUVVKcGxHSUEKTWVyU1Q0NkFyK0w0NnV6UmFkSEFPMXNDQVNGc0t0WGtsMDVUMytWcEhCcDRhVG9sQlVHUkdQWDVVbi9WVWUreAo1dHMvMm8zN2RJeC9abDhHOUZsVDVJdHJKTjRnUS8yK3dobjVLa0xqU0ZQb0lmb0tDbXhabVlQOUFnTUJBQUdqClVEQk9NQjBHQTFVZERnUVdCQlJTSUZJRzIyL2ZjeXZJU2JIN3FybGsvWGo0WGpBZkJnTlZIU01FR0RBV2dCUlMKSUZJRzIyL2ZjeXZJU2JIN3FybGsvWGo0WGpBTUJnTlZIUk1FQlRBREFRSC9NQTBHQ1NxR1NJYjNEUUVCQ3dVQQpBNElDQVFEWHBBbGlscmg3SEZnaGhTKzhxV08yODFlMGpEV05VKzFkZ1ZxUnc1bkE2WkNvNDI4SHNHMSs3V3hFCmRIc3BwdjRGSkVwdlp3dWE5NElWbVovbzllMGMyaHVwMFdFbiszcUwvdUpoMTlOdWxKYVFyQnVMWDFnWnlCd0cKcEZjRjMvcDZ2eENnTUo3V0V1V0RBYmdHMFhrTlhYRDlMTGFEZk0rOG1IbnQzS1ZpclQ1UTMxUVUyZUxBZGg4dApwY2lidkc1YWVQa2wvZzlhZUcyQkNiWVFhd1dEQTBOZmNIUnZ6MmkxbXhwMCtuWkRJSU1WUGZEcmxpRWh0NGRTCmtjOS9uKzdKNU9FZFZiSEZ5bURlMEFtbk5PRWQxa2hOSndTcnluS0xoRldxK1VQRHorcFkrcU96UDRJOVlGVUQKSnNBbXhlTWU0M0ZrRzlVUkVDSXJYRDNIYi81K0I4ZEhJL09MSTJTRjRKU0tBL0NOdWxhUklvc1IyMFZCdWJqNwp4SU5RWTAwSk9iUE5yNExUdWZQNWxoaTBwMWNZcHhZQ3VWT0hhL0IrZ29JSXdVaTg3NkFNSldRR21naHRvMWFhCmpEQnVBcTdjMXJvajBjWVlMQzBHei9HemJVY0RkQklROW8vQ0JPY3BKZE4xbFVkWVBZTThtYjY5MzdGV2VhL2IKcGl6Z0drWHR4Nm03L3RNUE5rV3pmeGlkM2hoZzJCTENka28rMUZFb1p0RUloM0QyZEgwSmhBcThMT3VYY3Z1Ugo1RjB6SGxrOUxYNFBkSGEwS3M2L3RIdEpaY1poR2tzVjhrK2JoUkRzQ1U5c2xWUlpNNTZ2R0o5U1V1K0QxWmViCmtJVEY0M2F1S1JkWHQrVmZQK0lCbDQ0dEdrWnp6cDYvWkUwNnh1U3U1UkFNeDI4UkV3PT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo="
)*/

func init() {
	err := envconfig.Process("SINKIT", &settings)
	if err != nil {
		log.Fatal(err.Error())
	}
	settings.Version = "0.5.0"
	if (settings.NUM_OF_CPUS == 0 || settings.NUM_OF_CPUS > runtime.NumCPU()) {
		settings.NUM_OF_CPUS = runtime.NumCPU()
	}
	log.Println("Settings loaded.")

	if (settings.LOCAL_RESOLVER) {
		//1369 magic number: base64 encoded 1024 ASCII chars.
		if (len(settings.CA_CRT_BASE64) < 1369) {
			log.Fatalf("SINKIT_CA_CRT_BASE64 env var string is too short to be valid, content: %s", settings.CA_CRT_BASE64)
		}
		if (len(settings.CLIENT_CRT_BASE64) < 1369) {
			log.Fatalf("SINKIT_CLIENT_CRT_BASE64 env var string is too short to be valid, content: %s", settings.CLIENT_CRT_BASE64)
		}
		if (len(settings.CLIENT_KEY_BASE64) < 1369) {
			log.Fatalf("SINKIT_CLIENT_KEY_BASE64 env var string is too short to be valid, content: %s", settings.CLIENT_KEY_BASE64)
		}
		if (settings.CLIENT_ID < 1) {
			log.Println("SINKIT_CLIENT_ID env var is not set to a meaningful int value. It will not be used.")
		} else {
			if (len(settings.CLIENT_ID_HEADER) < 1) {
				log.Println("SINKIT_CLIENT_ID env var is set, but the SINKIT_CLIENT_ID_HEADER seems too short to be valid.")
			}
		}
		if (settings.INSECURE_SKIP_VERIFY) {
			log.Println("SINKIT_INSECURE_SKIP_VERIFY is set to true. This is valid only in local testing environment.")
		}
		//log.Println(settings.CLIENT_CRT_BASE64)
		//log.Println(settings.CLIENT_KEY_BASE64)
		//log.Println(settings.CA_CRT_BASE64)

		clientCert, err := base64.StdEncoding.DecodeString(settings.CLIENT_CRT_BASE64)
		//clientCert, err := base64.StdEncoding.DecodeString(clientCertPEMBase64)

		//log.Println("@" + settings.CLIENT_CRT_BASE64 + "@")
		//log.Println("@" + os.Getenv("SINKIT_CLIENT_CRT_BASE64") + "@")
		//log.Println("@" + clientCertPEMBase64 + "@")

		if err != nil {
			log.Fatal(err.Error())
		}
		clientKey, err := base64.StdEncoding.DecodeString(settings.CLIENT_KEY_BASE64)
		//clientKey, err := base64.StdEncoding.DecodeString(clientKeyPEMBase64)
		if err != nil {
			log.Fatal(err.Error())
		}
		caCert, err := base64.StdEncoding.DecodeString(settings.CA_CRT_BASE64)
		//caCert, err := base64.StdEncoding.DecodeString(caCertPEMBase64)
		if err != nil {
			log.Fatal(err.Error())
		}
		keyPair, err := tls.X509KeyPair(clientCert, clientKey)
		if err != nil {
			log.Fatal(err.Error())
		}
		credentials.clientKeyPair = keyPair
		credentials.caCertPool = x509.NewCertPool()
		credentials.caCertPool.AppendCertsFromPEM(caCert)
		log.Println("Credentials loaded.")
	}
}
